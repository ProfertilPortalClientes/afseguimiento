sap.ui.define(["./BaseController","profertil/afeseguimiento/model/models","profertil/afeseguimiento/model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,o,n,r){"use strict";var a;return e.extend("profertil.afeseguimiento.controller.Principal",{formatter:o,onInit:function(){a=this;a.oGlobalBusyDialog=new sap.m.BusyDialog;this.getView().setModel(this.getOwnerComponent().getModel());a.oTextos=this.getOwnerComponent().getModel("i18n").getResourceBundle();this.getOwnerComponent().setModel(t.createAppModel(""),"appModel");this.getOwnerComponent().setModel(t.createSeguimientoModel(),"seguimientoModel");this.getOwnerComponent().setModel(t.createWorkflowModel(),"workflowModel");this.getOwnerComponent().setModel(t.createLanesModel(),"lanesModel");this.getOwnerComponent().setModel(t.createEstadosModel(),"estadosModel");this.getOwnerComponent().setModel(t.createUsuariosModel(),"usuariosModel");this.getOwnerComponent().setModel(t.createImputacionesModel(),"imputacionesModel");this.getOwnerComponent().setModel(t.createFiltrosModel(),"filtrosModel");this.getOwnerComponent().setModel(t.createLoginModel(),"loginModel");this.setRepoURLAdjuntos();this.getDataUsuario();this.getValueHelpImputacion();sap.ui.core.UIComponent.getRouterFor(this).getRoute("Principal").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(e){this.getView().getModel().metadataLoaded().then(function(){this.getData()}.bind(this))},handleGetSeguimientoAFES:function(e){this.getData()},getValueHelpImputacion:function(){this.getOwnerComponent().getModel().read("/ValueHelpImputacionSet",{success:function(e){this.getOwnerComponent().getModel("imputacionesModel").setProperty("/Imputaciones",e.results)}.bind(this),error:function(e){}.bind(this)})},getData:function(){var e=[];e.push(this.getSeguimientoAFES());e.push(this.getMatchcodeUsuariosData());a.oGlobalBusyDialog.setText(a.oTextos.getText("PrincipalTablaAFEBusy.text"));a.oGlobalBusyDialog.open();Promise.all(e).then(a.onSuccessData.bind(a),a.onErrorData.bind(a))},onSuccessData:function(e){a.oGlobalBusyDialog.close();var t=e[0].results.length>0?e[0].results:[];var o=e[1].results.length>0?e[1].results:[];t.forEach(function(e){if(e.MontoSolicitado<=5e5){e.Flujo=1}else if(e.MontoSolicitado>5e5&&e.MontoSolicitado<=1e6){e.Flujo=2}else if(e.MontoSolicitado>1e6){e.Flujo=3}});a.getOwnerComponent().getModel("seguimientoModel").setProperty("/Historial",t);a.getOwnerComponent().getModel("usuariosModel").setProperty("/Usuarios",o)},onErrorData:function(e){a.oGlobalBusyDialog.close()},getSeguimientoAFES:function(){return new Promise(function(e,t){var o=a.getOwnerComponent().getModel("filtrosModel").getProperty("/FechaDesde");var i=a.getOwnerComponent().getModel("filtrosModel").getProperty("/FechaHasta");var s=a.getOwnerComponent().getModel("filtrosModel").getProperty("/AFE");var l=a.getOwnerComponent().getModel("filtrosModel").getProperty("/Titulo");var d=a.getOwnerComponent().getModel("filtrosModel").getProperty("/Imputacion");var g=a.getOwnerComponent().getModel("filtrosModel").getProperty("/MontoPresupuestadoDesde")||"0";var c=a.getOwnerComponent().getModel("filtrosModel").getProperty("/MontoPresupuestadoHasta")||"999999999";var u=a.getOwnerComponent().getModel("filtrosModel").getProperty("/MontoSolicitadoDesde")||"0";var p=a.getOwnerComponent().getModel("filtrosModel").getProperty("/MontoSolicitadoHasta")||"999999999";var M=[];M.push(new n("FechaEmision",r.BT,o,i));if(s){M.push(new n("AFE",r.Contains,s))}if(l){M.push(new n("Titulo",r.Contains,l))}if(d){M.push(new n("ImputadoA",r.EQ,d))}M.push(new n("MontoPresupuestado",r.BT,g,c));M.push(new n("MontoSolicitado",r.BT,u,p));a.getOwnerComponent().getModel().read("/OrdenInversionSet",{filters:M,success:function(t,o){e(t)}.bind(a),error:function(e){t(e)}.bind(a)})})},getMatchcodeUsuariosData:function(){return new Promise(function(e,t){a.getOwnerComponent().getModel().read("/ValueHelpUsuarioSet",{success:function(t,o){e(t)}.bind(a),error:function(e){t(e)}.bind(a)})})},getDataUsuario:function(){var e="";this.getOwnerComponent().getModel().read("/DatosUsuarioSet('"+e+"')",{success:function(e,t){a.getOwnerComponent().getModel("loginModel").setProperty("/DatosUsuario",e)}.bind(this),error:function(e){}.bind(this)})},handleCreacionAFEPress:function(e){this.getOwnerComponent().getModel("appModel").setProperty("/Modo","creacion");var t=a.getOwnerComponent().getRouter();t.navTo("Creacion")},handleDetalleAFEPress:function(e){this.getOwnerComponent().getModel("appModel").setProperty("/Modo","visualizacion");var t=e.getSource().getBindingContext("seguimientoModel").getObject();var o=a.getOwnerComponent().getRouter();o.navTo("Detalle",{AFE:t.AFE})},handleGetEstadosWorkflowAFE:async function(e){debugger;var o=e.getSource().getBindingContext("seguimientoModel").getObject();a.getOwnerComponent().setModel(t.createWorkflowModel(),"workflowModel");a.oGlobalBusyDialog.setText("Obteniendo informaciÃ³n y generando el flujo de estados");a.oGlobalBusyDialog.open();try{var n=await this.getEstadosWorkflowAFE(o.AFE);var r=n.results.length>0?n.results:[];a.oGlobalBusyDialog.close();var i=a.getLanes(o.AFE);var s=a.getNodes(r);a.getOwnerComponent().getModel("workflowModel").setProperty("/Informacion/lanes",i);a.getOwnerComponent().getModel("workflowModel").setProperty("/Informacion/nodes",s);a.getOwnerComponent().getModel("appModel").setProperty("/AFE",o.AFE);this.oDialogoSeleccionWorkflow=sap.ui.xmlfragment("profertil.afeseguimiento.view.fragments.DialogoVisualizacionWorkflow",this);this.getView().addDependent(this.oDialogoSeleccionWorkflow);this.oDialogoSeleccionWorkflow.open()}catch(e){a.oGlobalBusyDialog.close()}},getLanes:function(e){var t=a.getOwnerComponent().getModel("seguimientoModel").getProperty("/Historial");var o=t.filter(function(t){return t.AFE===e});var n=o.length>=1?o[0]:{};var r=[];if(n&&n.MontoSolicitado<=5e5){r=a.getOwnerComponent().getModel("lanesModel").getProperty("/Flujo1")}else if(n&&n.MontoSolicitado>5e5&&n.MontoSolicitado<=1e6){r=a.getOwnerComponent().getModel("lanesModel").getProperty("/Flujo2")}else if(n&&n.MontoSolicitado>1e6){r=a.getOwnerComponent().getModel("lanesModel").getProperty("/Flujo3")}return r},getNodes:function(e){var t=[];e.forEach(function(o,n){var r=[],a=8,i="Positive",s="sap-icon://accept",l="Aprobado";if(o.EstadoActual>o.EstadoAnterior){switch(o.EstadoActual){case"8":break;case"9":a=2;s="sap-icon://decline",i="Negative",l="Rechazado";break;case"10":a=2;s="sap-icon://decline",i="Negative",l="Cancelado";break;default:if(e[n+1]&&e[n+1].EstadoAnterior==o.EstadoActual){r.push((n+1).toString())}break}}else{a=2;s="sap-icon://decline",i="Negative",l="Rechazado"}t.push({id:String(n),lane:o.EstadoAnterior,title:o.Responsable,nombre:o.ResponsableNombre,fecha:o.FechaHora,icono:s,colorScheme:a,titleAbbreviation:"AA",children:r,state:i,stateText:l,highlighted:false,focused:true,texts:"LALALA",quickView:{}})}.bind(this));return t},handleCerrarDialogoVisualizacion:function(e){this.oDialogoSeleccionWorkflow.close()},getEstadosWorkflowAFE:function(e){var t=a.getOwnerComponent().getModel().createKey("/OrdenInversionSet",{AFE:e});return new Promise(function(e,o){a.getOwnerComponent().getModel().read(t+"/To_Historial_Estados",{success:function(t){e(t)},error:function(e){o(e)}})})},setRepoURLAdjuntos:function(){debugger;var e=this.getManifestModel("adjuntosModel");this.getDataRepo("").then(t=>{var o=Object.keys(t).filter(e=>t[e].repositoryName=="AFES");var n=o[0]+"/root";var r=this.getDMSUrl("/SDM_API/browser/"+n);this._dmsUrl=r;e.setProperty("/url",r);e.setProperty("/repoId",o[0]);e.setProperty("/rootId",t[o[0]].rootFolderId)})},handleGetAFE:function(e){var t=this.getManifestModel("adjuntosModel").getData();var o=t.repoId+"/root"+"/"+"0000000001";var n="descarga.jpg";var r=this;this.getDataRepo(o).then(e=>{var o=r.getObjectId(e,n);if(o===""){r.navigateWithParameters(t.repoId,t.rootId)}else{r.navigateWithParameters(t.repoId,o)}}).catch(function(){r.navigateWithParameters(t.repoId,t.rootId)})},navigateWithParameters:function(e,t){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService){var o=sap.ushell.Container.getService("CrossApplicationNavigation");o.toExternal({target:{semanticObject:"reclrepo",action:"display"},params:{repoId:e,objectId:t}})}},getObjectId:function(e,t){for(var o=0;o<e.objects.length;o++){var n={};n=e.objects[o].object.properties;if(n["cmis:name"].value===t){return n["cmis:objectId"].value}}return""},handleUploadAdjunto:function(e,t){var o,n;var r="0000000028";this.getAFEFolder(r).then(()=>{var e=this.byId("idUploader2");var t=this.byId("idUploader2").getIncompleteItems();var a="/"+r;for(var i=0;i<t.length;i++){o=t[i].getFileObject();n=o.name;this.uploadSingleFile(o,n,a)}})},onReadFile:function(){var e=this.getManifestModel("adjuntosModel").getData();var t=e.repoId+"/root"+"/0000000001";var o="descarga.jpg";var n=this;this.getDataRepo(t).then(e=>{var r=n.getObjectId(e,o);sap.m.URLHelper.redirect(t+"/"+r,true)}).catch(function(){alert("ERROR")})}})});