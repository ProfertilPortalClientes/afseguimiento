sap.ui.define(["./BaseController","sap/ui/core/routing/History","sap/m/MessageBox","profertil/afeseguimiento/model/models","profertil/afeseguimiento/model/formatter"],function(e,o,t,s,r){"use strict";var a;return e.extend("profertil.afeseguimiento.controller.Creacion",{formatter:r,onInit:function(){a=this;a.oGlobalBusyDialog=new sap.m.BusyDialog;sap.ui.core.UIComponent.getRouterFor(this).getRoute("Creacion").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(e){this.getView().byId("idIconTabBar").setSelectedKey("DatosGenerales");this.getOwnerComponent().setModel(s.createAFEModel(),"AFEModel");var o=this.getOwnerComponent().getModel("loginModel").getProperty("/DatosUsuario/Usuario");this.getOwnerComponent().getModel("AFEModel").setProperty("/Creador",o);this.getOwnerComponent().setModel(s.createValueHelpModel(),"valueHelpModel");this.getOwnerComponent().setModel(s.createEstadosValidacionesModel(),"estadosValidaciones");this.getOwnerComponent().getModel("appModel")?this.getOwnerComponent().getModel("appModel").setProperty("/Modo","creacion"):this.getOwnerComponent().setModel(s.createAppModel("creacion"),"appModel");this.initDataValueHelps()},initDataValueHelps:function(){this.getValueHelpResponsable();this.getValueHelpJefe();this.getValueHelpSector();this.getValueHelpImputacion();this.getValueHelpMoneda();this.setValueHelpPeriodos()},getValueHelpResponsable:function(){this.getOwnerComponent().getModel().read("/ValueHelpResponsableSet",{success:function(e){this.getOwnerComponent().getModel("valueHelpModel").setProperty("/Responsables",e.results)}.bind(this),error:function(e){}.bind(this)})},getValueHelpJefe:function(){this.getOwnerComponent().getModel().read("/ValueHelpJefeSet",{success:function(e){this.getOwnerComponent().getModel("valueHelpModel").setProperty("/Jefes",e.results)}.bind(this),error:function(e){}.bind(this)})},getValueHelpSector:function(){this.getOwnerComponent().getModel().read("/ValueHelpSectorSet",{success:function(e){this.getOwnerComponent().getModel("valueHelpModel").setProperty("/Sectores",e.results)}.bind(this),error:function(e){}.bind(this)})},getValueHelpGerente:function(e){if(!e){return}var o=this.getOwnerComponent().getModel().createKey("/DatosResponsableSet",{Responsable:e});a.oGlobalBusyDialog.setText("Obteniendo el gerente");a.oGlobalBusyDialog.open();this.getOwnerComponent().getModel().read(o,{success:function(e){a.oGlobalBusyDialog.close();this.getOwnerComponent().getModel("AFEModel").setProperty("/Gerente",e.Gerente)}.bind(this),error:function(e){a.oGlobalBusyDialog.close()}.bind(this)})},getValueHelpImputacion:function(){this.getOwnerComponent().getModel().read("/ValueHelpImputacionSet",{success:function(e){this.getOwnerComponent().getModel("valueHelpModel").setProperty("/Imputaciones",e.results);this.changeImputacion("1")}.bind(this),error:function(e){}.bind(this)})},getValueHelpMoneda:function(){this.getOwnerComponent().getModel().read("/ValueHelpMonedaSet",{success:function(e){this.getOwnerComponent().getModel("valueHelpModel").setProperty("/Monedas",e.results)}.bind(this),error:function(e){}.bind(this)})},setValueHelpPeriodos:function(){var e=(new Date).getFullYear();var o=[];for(let t=e;t<e+10;t++){o.push({Periodo:t})}this.getOwnerComponent().getModel("valueHelpModel").setProperty("/PeriodosDesde",o);this.getOwnerComponent().getModel("valueHelpModel").setProperty("/PeriodosHasta",o)},handleSelectResponsable:function(e){var o=e.getSource().getSelectedKey();if(o){this.getValueHelpGerente(o)}},handleChangeImputadoA:function(e){},handleNavBack:function(e){var t=a.getOwnerComponent().getRouter();var s=o.getInstance();var r=s.getPreviousHash();if(r!==undefined){history.go(-1)}else{var n=true;t.navTo("Principal",{},n)}},handleDescomposicionGastoPress:function(e){if(!this.validarPeriodos()){sap.m.MessageToast.show("Para cargar la descomposición de los gastos debe ingresar los períodos desde/hasta");return}if(!this.validarPeriodosDiferencia()){sap.m.MessageToast.show("Para cargar la descomposición de los gastos la diferencia de los períodos desde/hasta debe ser de máximo 5 años");return}if(!this.validarMontoSolicitado()){sap.m.MessageToast.show("Para cargar la descomposición de los gastos debe ingresar el monto solicitado");return}this.getDialogDescomposicionGasto().open()},handleCloseDescomposicionGastoPress:function(e){this.getDialogDescomposicionGasto().close()},getDialogDescomposicionGasto:function(){if(!this.oDialogDescomposicionGasto){this.oDialogDescomposicionGasto=sap.ui.xmlfragment("profertil.afeseguimiento.view.fragments.DescomposicionGasto",this);this.getView().addDependent(this.oDialogDescomposicionGasto)}return this.oDialogDescomposicionGasto},validarPeriodos:function(){var e=true;var o="None";var t=this.getOwnerComponent().getModel("estadosValidaciones");var s=this.getOwnerComponent().getModel("AFEModel").getProperty("/PeriodoDesde");var r=this.getOwnerComponent().getModel("AFEModel").getProperty("/PeriodoHasta");if(!s||!s||s>r){e=false;o="Error"}t.setProperty("/DatosGenerales_PeriodoDesde",o);t.setProperty("/DatosGenerales_PeriodoHasta",o);return e},validarPeriodosDiferencia:function(){var e=true;var o=false;var t=false;var s=false;var r=false;var a=false;var n=0;var i="None";var l=this.getOwnerComponent().getModel("estadosValidaciones");var d=this.getOwnerComponent().getModel("AFEModel").getProperty("/PeriodoDesde");var c=this.getOwnerComponent().getModel("AFEModel").getProperty("/PeriodoHasta");if(d&&c&&d<=c){n=c-d;if(n>4){e=false;i="Error"}else{for(var p=0;p<5;p++){if(p<=n){switch(p){case 0:o=true;break;case 1:t=true;break;case 2:s=true;break;case 3:r=true;break;case 4:a=true;break;default:break}}else{switch(p){case 0:this.getOwnerComponent().getModel("AFEModel").setProperty("/DescomposicionGasto1",0);break;case 1:this.getOwnerComponent().getModel("AFEModel").setProperty("/DescomposicionGasto2",0);break;case 2:this.getOwnerComponent().getModel("AFEModel").setProperty("/DescomposicionGasto3",0);break;case 3:this.getOwnerComponent().getModel("AFEModel").setProperty("/DescomposicionGasto4",0);break;case 4:this.getOwnerComponent().getModel("AFEModel").setProperty("/DescomposicionGasto5",0);break;default:break}}}}}else{e=false;i="Error"}this.getOwnerComponent().getModel("appModel").setProperty("/DescomposicionGasto1Enabled",o);this.getOwnerComponent().getModel("appModel").setProperty("/DescomposicionGasto2Enabled",t);this.getOwnerComponent().getModel("appModel").setProperty("/DescomposicionGasto3Enabled",s);this.getOwnerComponent().getModel("appModel").setProperty("/DescomposicionGasto4Enabled",r);this.getOwnerComponent().getModel("appModel").setProperty("/DescomposicionGasto5Enabled",a);l.setProperty("/DatosGenerales_PeriodoDesde",i);l.setProperty("/DatosGenerales_PeriodoHasta",i);return e},validarMontoSolicitado:function(){var e=true;var o="None";var t=this.getOwnerComponent().getModel("estadosValidaciones");var s=this.getOwnerComponent().getModel("AFEModel").getProperty("/MontoSolicitado");if(!s||parseFloat(s)<=0){e=false;o="Error"}t.setProperty("/DatosGenerales_MontoSolicitado",o);return e},uploadAdjuntos:function(e){var o=a.getView().getModel("AFEModel").getProperty("/AdjuntosF");var t=0;var s=new FileReader;s.onload=function(e){o[t].valor=e.target.result};s.onloadend=function(){t++;if(o[t]){this.readAsDataURL(o[t])}else{a.agregarAdjuntos(o,e)}};if(o.length>0){s.readAsDataURL(o[t])}else{a.agregarAdjuntos([],e)}},agregarAdjuntos:function(e,o){if(e.length>0){var t=[];this.createFolder(o).catch(()=>{sap.m.MessageBox.error("Error en la subida de los adjuntos al repositorio. Contacte a su administrador",{onClose:function(e){a.handleNavBack()}})}).then(()=>{var s="/"+o;for(var r=0;r<e.length;r++){var n=e[r];var i=e[r].name;t.push(this.uploadSingleFilePromise(n,i,s))}Promise.all(t).then(a.onSuccessUpload.bind(a),a.onErrorUpload.bind(a))})}},onSuccessUpload:function(e){sap.m.MessageBox.success("Adjuntos subidos correctamente",{onClose:function(e){a.handleNavBack()}})},onErrorUpload:function(e){sap.m.MessageBox.error("Error en la subida de los adjuntos al repositorio. Contacte a su administrador",{onClose:function(e){a.handleNavBack()}})},handleUploadAdjunto:function(e){var o=a.getView().byId("idUploader");var t=jQuery.sap.domById(o.getId()+"-fu").files;var s=a.getView().getModel("AFEModel").getProperty("/Adjuntos");var r=[];var n=0;var i=[];var l=[];var d;if(!s){s=[]}for(var c=0;c<t.length;c++){var p=false,u=0;while(!p&&u<s.length){p=s[u].name===t[c].name;u++}if(!p){r.push(t[c])}}for(c=0;c<r.length;c++){n+=r[c].size}for(c=0;c<s.length;c++){n+=s[c].size}if(n>10*1024*1024){sap.m.MessageToast.show("Los archivos seleccionados exceden el tamaño máximo permitido");return false}s=s.concat(r);for(c=0;c<s.length;c++){l=s[c].name.toString().split(".");d=l[l.length-1];i.push({name:s[c].name,filename:s[c].name,Extension:d})}a.getView().getModel("AFEModel").setProperty("/Adjuntos",i);a.getView().getModel("AFEModel").setProperty("/AdjuntosF",s)},handleEliminarAdjunto:function(e){var o=e.getSource().getParent();var t=o.getParent().indexOfItem(o);var s=a.getView().getModel("AFEModel").getProperty("/Adjuntos");s.splice(t,1);a.getView().getModel("AFEModel").setProperty("/Adjuntos",s)},validacionesCreacionAFE:function(){var e=false;var o=this.getOwnerComponent().getModel("AFEModel").getData();return e},handleCreacionAFEPress:function(){if(this.handleValidacionesCreacion()){sap.m.MessageBox.error("Complete los campos obligatorios");return}if(this.handleValidacionesMontoSolicitado()){sap.m.MessageBox.error("Revise el monto solicitado. La descomposición del gasto debe de coincidir con el monto requerido");return}var e=new sap.m.Dialog({type:sap.m.DialogType.Message,title:"Confirmación",content:new sap.m.Text({text:"¿Está seguro que desea generar la orden de inversión?"}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:"Aceptar",press:function(){e.close();a.crearAFE()}.bind(this)}),endButton:new sap.m.Button({text:"Cancelar",press:function(){e.close()}.bind(this)})});e.open()},crearAFE:function(){if(this.handleValidacionesCreacion()){sap.m.MessageBox.error("Complete los campos obligatorios");return}if(this.handleValidacionesMontoSolicitado()){sap.m.MessageBox.error("Revise el monto solicitado. La descomposición del gasto debe de coincidir con el monto requerido");return}var e=this.getOwnerComponent().getModel("AFEModel").getData();var o=this.getOwnerComponent().getModel("AFEModel").getProperty("/Adjuntos");o=o&&o.length>0?o:[];var t={AFE:"",Estado:e.Creador===e.Responsable?"3":"2",Complementario:e.Complementario,NumeroRevision:e.NumeroRevision.toString(),FechaEmision:e.FechaEmision,Creador:"",Responsable:e.Responsable,Jefe:e.Jefe,Gerente:e.Gerente,SectorOrigen:e.SectorOrigen,PeriodoDesde:e.PeriodoDesde,PeriodoHasta:e.PeriodoHasta,ImputadoA:e.ImputadoA,Titulo:e.Titulo,Categoria:e.Categoria,Codigo:e.Codigo,TipoInversionMantCapital:e.TipoInversionMantCapital,TipoInversionCrecRentabilidad:e.TipoInversionCrecRentabilidad,MontoPresupuestado:e.MontoPresupuestado,MontoSolicitado:e.MontoSolicitado,MontoSolicitadoMoneda:e.MontoSolicitadoMoneda,MontoMonedaOrigen:e.MontoMonedaOrigen,MontoMonedaOrigenMoneda:e.MontoMonedaOrigenMoneda,Diferencia:e.Diferencia,MontoCompensado:e.MontoCompensado,Desvio:e.Desvio,DescomposicionGasto1:e.DescomposicionGasto1.toString(),DescomposicionGasto2:e.DescomposicionGasto2.toString(),DescomposicionGasto3:e.DescomposicionGasto3.toString(),DescomposicionGasto4:e.DescomposicionGasto4.toString(),DescomposicionGasto5:e.DescomposicionGasto5.toString(),ResumenPropuesta:e.ResumenPropuesta,AniosVidaUtilEstimados:e.AniosVidaUtilEstimados.toString(),FechaEstimadaCierre:e.FechaEstimadaCierre,RetornoInversion:e.RetornoInversion,IncluyeReemplazos:e.IncluyeReemplazos,Observacion:e.Observacion,InformeTecnicoDescripcion:e.IncluyeReemplazos?e.InformeTecnicoDescripcion:"",InformeTecnicoDestino:e.IncluyeReemplazos?e.InformeTecnicoDestino:"",InformeTecnicoCalculo:e.IncluyeReemplazos?e.InformeTecnicoCalculo:"",DatosComplementariosObjetivo:e.DatosComplementariosObjetivo,DatosComplementariosJustificacion:e.DatosComplementariosJustificacion,DatosComplementariosAlcance:e.DatosComplementariosAlcance,DatosComplementariosAntecedentes:e.DatosComplementariosAntecedentes,DatosComplementariosEstimacion:e.DatosComplementariosEstimacion,DatosComplementariosAlternativas:e.DatosComplementariosAlternativas,DatosComplementariosVariacion:e.DatosComplementariosVariacion,DatosComplementariosImpactoAmbiental:e.DatosComplementariosImpactoAmbiental,DatosComplementariosCronograma:e.DatosComplementariosCronograma,To_Adjuntos:[]};a.oGlobalBusyDialog.setText("Generando AFE. Aguarde por favor");a.oGlobalBusyDialog.open();this.getOwnerComponent().getModel().bUseBatch=false;this.getOwnerComponent().getModel().create("/OrdenInversionSet",t,{success:function(e){a.oGlobalBusyDialog.close();var t=e.AFE;if(t){if(o.length>0){sap.m.MessageBox.success("AFE "+t+" generada correctamente. Se realizará la subida de los adjuntos al repositorio",{onClose:function(e){a.uploadAdjuntos(t)}})}else{sap.m.MessageBox.success("AFE "+t+" generada correctamente",{onClose:function(e){a.handleNavBack()}})}}}.bind(this),error:function(e){if(e.responseText){var o=JSON.parse(e.responseText)}var t=o.error.message.value||"Error al crear la orden de inversión";sap.m.MessageBox.error(t);a.oGlobalBusyDialog.close()}.bind(this)})},handleValidacionesCreacion:function(){var e=false;var o=this.getOwnerComponent().getModel("AFEModel").getData();var t=this.getOwnerComponent().getModel("estadosValidaciones");if(!o.NumeroRevision){e=true;t.setProperty("/DatosGenerales_NumeroRevision","Error")}else{t.setProperty("/DatosGenerales_NumeroRevision","None")}if(!o.FechaEmision){e=true;t.setProperty("/DatosGenerales_FechaEmision","Error")}else{t.setProperty("/DatosGenerales_FechaEmision","None")}if(!o.Creador){e=true;t.setProperty("/DatosGenerales_Creador","Error")}else{t.setProperty("/DatosGenerales_Creador","None")}if(!o.Responsable){e=true;t.setProperty("/DatosGenerales_Responsable","Error")}else{t.setProperty("/DatosGenerales_Responsable","None")}if(!o.Gerente){e=true;t.setProperty("/DatosGenerales_Gerente","Error")}else{t.setProperty("/DatosGenerales_Gerente","None")}if(!o.SectorOrigen){e=true;t.setProperty("/DatosGenerales_SectorOrigen","Error")}else{t.setProperty("/DatosGenerales_SectorOrigen","None")}if(!o.PeriodoDesde){e=true;t.setProperty("/DatosGenerales_PeriodoDesde","Error")}else{t.setProperty("/DatosGenerales_PeriodoDesde","None")}if(!o.PeriodoHasta){e=true;t.setProperty("/DatosGenerales_PeriodoHasta","Error")}else{t.setProperty("/DatosGenerales_PeriodoHasta","None")}if(o.PeriodoDesde&&o.PeriodoHasta&&o.PeriodoDesde>o.PeriodoHasta){e=true;t.setProperty("/DatosGenerales_PeriodoHasta","Error")}else{t.setProperty("/DatosGenerales_PeriodoHasta","None")}if(!o.ImputadoA){e=true;t.setProperty("/DatosGenerales_ImputadoA","Error")}else{t.setProperty("/DatosGenerales_ImputadoA","None");if((o.ImputadoA==="1"||o.ImputadoA==="2"||o.ImputadoA==="3")&&!o.Titulo){e=true;t.setProperty("/DatosGenerales_Titulo","Error")}else{t.setProperty("/DatosGenerales_Titulo","None")}}if(!o.MontoSolicitado||parseFloat(o.MontoSolicitado)<=0){e=true;t.setProperty("/DatosGenerales_MontoSolicitado","Error")}else{t.setProperty("/DatosGenerales_MontoSolicitado","None")}if(!o.AniosVidaUtilEstimados||parseInt(o.AniosVidaUtilEstimados)<=0){e=true;t.setProperty("/DatosGenerales_AniosVidaUtilEstimados","Error")}else{t.setProperty("/DatosGenerales_AniosVidaUtilEstimados","None")}if(!o.FechaEstimadaCierre){e=true;t.setProperty("/DatosGenerales_FechaEstimadaCierre","Error")}else{t.setProperty("/DatosGenerales_FechaEstimadaCierre","None")}if(!o.InformeTecnicoDescripcion&&o.IncluyeReemplazos){e=true;t.setProperty("/DatosInformeTecnico_Descripcion","Error")}else{t.setProperty("/DatosInformeTecnico_Descripcion","None")}if(!o.InformeTecnicoDestino&&o.IncluyeReemplazos){e=true;t.setProperty("/DatosInformeTecnico_Destino","Error")}else{t.setProperty("/DatosInformeTecnico_Destino","None")}if(!o.InformeTecnicoCalculo&&o.IncluyeReemplazos){e=true;t.setProperty("/DatosInformeTecnico_Calculo","Error")}else{t.setProperty("/DatosInformeTecnico_Calculo","None")}if(!o.DatosComplementariosObjetivo){e=true;t.setProperty("/DatosComplementarios_Objetivo","Error")}else{t.setProperty("/DatosComplementarios_Objetivo","None")}if(!o.DatosComplementariosJustificacion){e=true;t.setProperty("/DatosComplementarios_Justificacion","Error")}else{t.setProperty("/DatosComplementarios_Justificacion","None")}if(!o.DatosComplementariosAlcance){e=true;t.setProperty("/DatosComplementarios_Alcance","Error")}else{t.setProperty("/DatosComplementarios_Alcance","None")}if(!o.DatosComplementariosVariacion){e=true;t.setProperty("/DatosComplementarios_Variacion","Error")}else{t.setProperty("/DatosComplementarios_Variacion","None")}return e},handleValidacionesMontoSolicitado:function(){var e=false;var o=this.getOwnerComponent().getModel("AFEModel").getData();var t=this.getOwnerComponent().getModel("estadosValidaciones");var s=this.validarPeriodosDiferencia();var r=parseFloat(o.DescomposicionGasto1)+parseFloat(o.DescomposicionGasto2)+parseFloat(o.DescomposicionGasto3)+parseFloat(o.DescomposicionGasto4)+parseFloat(o.DescomposicionGasto5);if(!o.MontoSolicitado||parseFloat(o.MontoSolicitado)<=0||parseFloat(o.MontoSolicitado)!==parseFloat(r)||!s){e=true;t.setProperty("/DatosGenerales_MontoSolicitado","Error")}else{t.setProperty("/DatosGenerales_MontoSolicitado","None")}return e},handleChangeImputacion:function(e){debugger;var o=e.getSource().getSelectedKey();a.changeImputacion(o)},changeImputacion:function(e){if(!e){return}var o;var t;var s;var r=false;var n=false;var i=false;var l=false;var d=this.getOwnerComponent().getModel("valueHelpModel").getProperty("/Imputaciones");if(e&&e!=="1"&&e!=="2"&&e!=="3"){var c=d.filter(function(o){return o.NumeroOrden===e});var p=c.length?c[0]:{};if(p){o=p.Titulo;t=p.Categoria;s=p.Codigo;switch(t){case"MA":case"MU":case"CA":case"PP":r=true;break;case"IN":case"HW":case"CR":n=true;break;default:break}}a.getMontoPresupuestado(e)}else{i=true;r=false;n=false;if(e==="1"||e==="2"||e==="3"){l=true;this.getOwnerComponent().getModel("AFEModel").setProperty("/MontoPresupuestado","0")}}this.getOwnerComponent().getModel("AFEModel").setProperty("/Titulo",o);this.getOwnerComponent().getModel("AFEModel").setProperty("/TituloEditable",l);this.getOwnerComponent().getModel("AFEModel").setProperty("/Categoria",t);this.getOwnerComponent().getModel("AFEModel").setProperty("/Codigo",s);this.getOwnerComponent().getModel("AFEModel").setProperty("/TipoInversionMantCapital",r);this.getOwnerComponent().getModel("AFEModel").setProperty("/TipoInversionCrecRentabilidad",n);this.getOwnerComponent().getModel("AFEModel").setProperty("/TipoInversionDatosEditables",i)},getMontoPresupuestado:function(e){if(!e){return}var o=this.getOwnerComponent().getModel().createKey("/ValueHelpImputacionSet",{NumeroOrden:e});var t=o+"/To_MontoPresupuestado";a.oGlobalBusyDialog.setText("Obteniendo el monto presupuestado. Aguarde por favor");a.oGlobalBusyDialog.open();this.getOwnerComponent().getModel().read(t,{success:function(e){var o=parseFloat(e.Monto)||"0";this.getOwnerComponent().getModel("AFEModel").setProperty("/MontoPresupuestado",o);a.oGlobalBusyDialog.close()}.bind(this),error:function(e){a.oGlobalBusyDialog.close()}.bind(this)})},handleChangeIncluyeReemplazos:function(){var e=this.getOwnerComponent().getModel("AFEModel").getProperty("/IncluyeReemplazos");if(!e){this.getOwnerComponent().getModel("AFEModel").setProperty("/InformeTecnicoDescripcion","");this.getOwnerComponent().getModel("AFEModel").setProperty("/InformeTecnicoDestino","");this.getOwnerComponent().getModel("AFEModel").setProperty("/InformeTecnicoCalculo","")}}})});