sap.ui.define(["./BaseController","sap/ui/core/routing/History","profertil/afeseguimiento/model/models","profertil/afeseguimiento/model/formatter"],function(e,o,t,n){"use strict";var s;return e.extend("profertil.afeseguimiento.controller.Detalle",{formatter:n,onInit:function(){s=this;s.oGlobalBusyDialog=new sap.m.BusyDialog;this.getOwnerComponent().setModel(t.createAFEModel(),"AFEModel");sap.ui.core.UIComponent.getRouterFor(this).getRoute("Detalle").attachPatternMatched(this._onObjectMatched,this);this.getOwnerComponent().getModel("appModel")?this.getOwnerComponent().getModel("appModel").setProperty("/Modo","visualizacion"):this.getOwnerComponent().setModel(t.createAppModel("visualizacion"),"appModel")},_onObjectMatched:function(e){this.AFE=e.getParameter("arguments").AFE;this.getView().getModel().metadataLoaded().then(function(){var e="/"+s.getOwnerComponent().getModel().createKey("OrdenInversionSet",{AFE:s.AFE});this.getAFE(e);this.getAFEAdjuntos(s.AFE)}.bind(this))},getAFE:function(e){s.oGlobalBusyDialog.setText("Obteniendo AFE. Aguarde por favor");s.oGlobalBusyDialog.open();this.getOwnerComponent().getModel().read(e,{success:function(e,o){s.oGlobalBusyDialog.close();var t=e;this.getOwnerComponent().getModel("AFEModel").setData(t)}.bind(this),error:function(e){s.oGlobalBusyDialog.close()}.bind(this)})},handleNavBack:function(e){var t=s.getOwnerComponent().getRouter();var n=o.getInstance();var a=n.getPreviousHash();if(a!==undefined){history.go(-1)}else{var i=true;t.navTo("Principal",{},i)}},getAFEAdjuntos:function(e){var o=[];var t=this.getManifestModel("adjuntosModel");var n=t.getData();var s=n.repoId+"/root"+"/"+e;var a=this;this.getDataRepo(s).then(e=>{o=a.getAdjuntos(e);if(o.length===0){o=[{filename:"No se encontraron Adjuntos",url:"",objectId:""}]}a.getOwnerComponent().getModel("AFEModel").setProperty("/Adjuntos",o)}).catch(e=>{o=[{filename:"No se encontraron Adjuntos",url:"",objectId:""}];a.getManifestModel("adjuntosModel").setProperty("/adjuntos",o)})},getAdjuntos:function(e){var o=[];for(var t=0;t<e.objects.length;t++){var n={};n=e.objects[t].object.properties;var s={};s=this.getAdjuntoProperties(n);o.push(s)}return o},getAdjuntoProperties:function(e){var o={};o.objectId=e["cmis:objectId"].value;o.filename=e["cmis:name"].value;o.url=this.getDMSUrl("/SDM_API/browser")+"/"+this.getManifestModel("adjuntosModel").getData().repoId+"/root"+"?objectId="+o.objectId+"&cmisSelector=content&download=attachment&filename="+o.filename;return o},handleDescargarAdjunto:function(e){var o=e.getSource().getBindingContext("AFEModel").getProperty("url");if(o!==""){window.open(o,"_self")}},navigateWithParameters:function(e,o){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService){var t=sap.ushell.Container.getService("CrossApplicationNavigation");t.toExternal({target:{semanticObject:"reclrepo",action:"display"},params:{repoId:e,objectId:o}})}},getObjectId:function(e,o){for(var t=0;t<e.objects.length;t++){var n={};n=e.objects[t].object.properties;if(n["cmis:name"].value===o){return n["cmis:objectId"].value}}return""},handleDescomposicionGastoPress:function(e){this.getOwnerComponent().getModel("appModel").setProperty("/DescomposicionGasto1Enabled",false);this.getOwnerComponent().getModel("appModel").setProperty("/DescomposicionGasto2Enabled",false);this.getOwnerComponent().getModel("appModel").setProperty("/DescomposicionGasto3Enabled",false);this.getOwnerComponent().getModel("appModel").setProperty("/DescomposicionGasto4Enabled",false);this.getOwnerComponent().getModel("appModel").setProperty("/DescomposicionGasto5Enabled",false);this.getDialogDescomposicionGasto().open()},getDialogDescomposicionGasto:function(){if(!this.oDialogDescomposicionGasto){this.oDialogDescomposicionGasto=sap.ui.xmlfragment("profertil.afeseguimiento.view.fragments.DescomposicionGasto",this);this.getView().addDependent(this.oDialogDescomposicionGasto)}return this.oDialogDescomposicionGasto},handleCloseDescomposicionGastoPress:function(e){this.getDialogDescomposicionGasto().close()}})});